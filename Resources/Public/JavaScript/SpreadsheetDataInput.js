define(["TYPO3/CMS/Core/DocumentService"],(function(e){return function(){"use strict";var t={384:function(t){t.exports=e}},r={};function s(e){var i=r[e];if(void 0!==i)return i.exports;var n=r[e]={exports:{}};return t[e](n,n.exports,s),n.exports}s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,{a:t}),t},s.d=function(e,t){for(var r in t)s.o(t,r)&&!s.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var i={};return function(){function e(e){const t=e.toString(24);let r="";for(let e=0;e<t.length;e++){let s=t[e],i=(1*s).toString()===s?s:s.charCodeAt(0)-97+10;0===e&&(i-=1),r+=String.fromCharCode(97+i)}return r.toUpperCase()}function t(e){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZ";let r=0;for(let s=0,i=e.length-1;s<e.length;s+=1,i-=1)r+=Math.pow(t.length,i)*(t.indexOf(e[s])+1);return r}function r(t,r){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return"row"===s?r:"column"===s?e(t):e(t)+r}function n(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=parseInt(e.getAttribute("data-col"));!0===t&&!0===e.hasAttribute("colspan")&&(r+=parseInt(e.getAttribute("colspan"))-1);let s=parseInt(e.getAttribute("data-row"));return!0===t&&!0===e.hasAttribute("rowspan")&&(s+=parseInt(e.getAttribute("rowspan"))-1),{colIndex:r,rowIndex:s}}s.r(i);class l{constructor(e){if(this.properties={},0===e.length)return;const t=e.match(/^spreadsheet:\/\/(\d+)(?:\?(.+))?/);if(null===t)throw new Error('DSN class expects value to be of type string and format "spreadsheet://index=0..."');if(void 0===t[2])this.properties.fileUid=t[1];else{const e=JSON.parse('{"'+t[2].replace(/&/g,'","').replace(/=/g,'":"')+'"}',(function(e,t){return""===e?t:decodeURIComponent(t)}));this.properties.fileUid=t[1],this.properties.index=e.index||0,this.properties.direction=e.direction||"horizontal",this.range=e.range||""}}get fileUid(){return this.properties.fileUid}set fileUid(e){this.properties.fileUid=e}get index(){return this.properties.index}set index(e){this.properties.index=e}get coordinates(){return this.properties.coordinates||null}get range(){return this.properties.range||""}set range(e){this.properties.range=e;let r=e.match(/^([A-Z]+|\d+)(\d+)?:([A-Z]+|\d+)(\d+)?$/);null!==r&&(r=Array.from(r).slice(1),Number.isNaN(parseInt(r[0]))||(r[1]=parseInt(r[0]),r[0]=null),Number.isNaN(parseInt(r[2]))||(r[3]=parseInt(r[2]),r[2]=null),r[0]=r[0]||r[2]||null,r[2]=r[2]||r[0],r[1]=r[1]||r[3]||null,r[3]=r[3]||r[1],this.properties.coordinates={startCol:null!==r[0]?t(r[0]):null,startRow:null!==r[1]?parseInt(r[1]):null,endCol:null!==r[2]?t(r[2]):null,endRow:null!==r[3]?parseInt(r[3]):null})}get direction(){return this.properties.direction||""}set direction(e){this.properties.direction=e}}class a{constructor(e,t){this.sheetWrapper=e,this.sheetWrapper.addEventListener("click",(e=>{if("A"===e.target.tagName){for(let t of e.target.parentNode.childNodes)t.classList.remove("active");e.target.classList.add("active"),this.sheetWrapper.dispatchEvent(new CustomEvent("changeIndex",{detail:{index:e.target.getAttribute("data-value")}}))}})),null!==t&&(this.tableWrapper=t)}update(e,t){if(!(t instanceof l))throw new Error('Renderer class "update" method expects parameter to be type of a DSN class');this.buildTabs(e,t.index),this.buildTable(e,t.coordinates)}buildTabs(e,t){if(this.sheetWrapper.textContent="",e.getAllSheets().length<=0)this.sheetWrapper.style.display="none";else{for(let r=0;r<e.getAllSheets().length;r++){const s=document.createElement("a");s.setAttribute("href","#"),s.setAttribute("data-value",r),s.innerText=e.getSheetName(r);const i=document.createElement("li");r===parseInt(t)&&i.classList.add("active"),i.appendChild(s),this.sheetWrapper.appendChild(i)}this.sheetWrapper.style.display="block"}}buildTable(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(void 0===this.tableWrapper||null===this.tableWrapper)return;const r=Object.values(e.getSheetData()).map((e=>Object.values(e)));if(r.length<=0)return;const s=document.createElement("table");this.buildTableHeader(s,Math.max(...r.map((e=>e.length)))),this.buildTableBody(s,r,t),this.tableWrapper.textContent="",this.tableWrapper.appendChild(s),this.tableWrapper.style.display="block"}buildTableHeader(t,r){const s=t.createTHead().insertRow();for(let t=0;t<=r;t++)if(t>0){const r=s.insertCell();r.innerText=e(t),r.setAttribute("data-col",t)}else s.insertCell()}buildTableBody(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;const s=e.createTBody();let i=[];t.forEach(((e,t)=>{const n=s.insertRow(),l=n.insertCell();l.innerText=t+1,l.setAttribute("data-row",t+1);let a=0;e.forEach((e=>{const s=n.insertCell();if(s.innerText=e.val,void 0!==e.css&&s.setAttribute("class",e.css.split("-").filter((e=>e.length>0)).map((e=>"align-"+e)).join(" ")),void 0!==e.col){s.setAttribute("colspan",e.col);for(let r=1;r<e.col;r++)i.push(t+"-"+(a+r))}if(void 0!==e.row){s.setAttribute("rowspan",e.row);for(let r=1;r<e.row;r++)if(i.push(t+r+"-"+a),void 0!==e.col)for(let s=1;s<e.col;s++)i.push(t+r+"-"+(a+s))}for(;-1!==i.indexOf(t+"-"+a);)a++;s.setAttribute("data-col",a+1),s.setAttribute("data-row",t+1),null!==r&&r.startRow<=t+1&&r.endRow>=t+1&&r.startCol<=a+1&&r.endCol>=a+1&&s.classList.add("highlight"),a++}))}))}}class o{constructor(e,t){if(!(e instanceof l))throw new Error("Spreadsheet class expects dsn parameter to be type of a DSN class");this.data=t,this.defaultFileUid=e.fileUid,this.defaultSheetIndex=e.index}set dsn(e){if(!(e instanceof l))throw new Error('Spreadsheet class setter "dsn" expects parameter to be type of a DSN class');this.defaultFileUid=e.fileUid,this.defaultSheetIndex=e.index}getAllSheets(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.defaultFileUid;return this.data[e]||[]}getSheet(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.defaultSheetIndex,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.defaultFileUid;return void 0===this.data[t]?[]:this.data[t][e]||[]}getSheetName(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.defaultSheetIndex,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.defaultFileUid;return this.getSheet(e,t).name||""}getSheetData(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.defaultSheetIndex,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.defaultFileUid;return this.getSheet(e,t).cells||[]}}class d{constructor(e){if(this.cursor={isSelecting:!1,selectMode:null},this.properties={},this.tableWrapper=e,null!==this.tableWrapper){this.tableWrapper.addEventListener("mousedown",(e=>{const t=document.elementFromPoint(e.x,e.y);this.cursor.isSelecting=!0,this.cursor.start=t,this.cursor.selectMode=null,this.reachedColumnHeader(t)?this.cursor.selectMode="column":this.reachedRowHeader(t)&&(this.cursor.selectMode="row")}));const e=e=>{if(!0!==this.cursor.isSelecting)return!1;"mouseup"===e.type&&(this.cursor.isSelecting=!1,window.getSelection?window.getSelection().empty?window.getSelection().empty():window.getSelection().removeAllRanges&&window.getSelection().removeAllRanges():document.selection&&document.selection.empty());const t=document.elementFromPoint(e.x,e.y);return!1!==this.isInsideTable(t)&&((!this.reachedColumnHeader(t)||!this.reachedRowHeader(t))&&(("column"!==this.cursor.selectMode||!this.reachedRowHeader(t))&&(("row"!==this.cursor.selectMode||!this.reachedColumnHeader(t))&&((null!==this.cursor.selectMode||!this.reachedColumnHeader(t)&&!this.reachedRowHeader(t))&&(t!==this.cursor.start?(this.cursor.end=t,this.selection=[this.cursor.start,this.cursor.end]):this.selection=[this.cursor.start],this.calculateMergeCells(),this.highlightSelection(),void this.tableWrapper.dispatchEvent(new CustomEvent("changeSelection",{detail:{start:this.selection.start,end:this.selection.end}})))))))};this.tableWrapper.addEventListener("mousemove",function(e,t){let r,s;return function(){const i=this,n=arguments;s?(clearTimeout(r),r=setTimeout((function(){Date.now()-s>=e&&(t.apply(i,n),s=Date.now())}),e-(Date.now()-s))):(t.apply(i,n),s=Date.now())}}(60,e)),this.tableWrapper.addEventListener("mouseup",e)}}get selection(){return this.properties.selection}set selection(e){if(e.length<=0)return;let t={min:null,max:null},s={min:null,max:null};e.forEach((e=>{const r=n(e,!1);(null===t.min||t.min>r.colIndex)&&(t.min=r.colIndex),(null===s.min||s.min>r.rowIndex)&&(s.min=r.rowIndex);const i=n(e,!0);(null===t.max||t.max<i.colIndex)&&(t.max=i.colIndex),(null===s.max||s.max<i.rowIndex)&&(s.max=i.rowIndex)})),this.properties.selection={elements:e,indexes:{col:t,row:s}},this.properties.selection.start=r(t.min,s.min,this.cursor.selectMode),1===e.length?this.properties.selection.end=this.properties.selection.start:this.properties.selection.end=r(t.max,s.max,this.cursor.selectMode)}isInsideTable(e){return null!==e&&null!==e.closest("table")}reachedColumnHeader(e){return null!==e&&null!==e.closest("thead")}reachedRowHeader(e){return null!==e&&e.closest("tr").querySelector("td")===e}calculateMergeCells(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=this.selection.indexes.col,r=this.selection.indexes.row;"row"===this.cursor.selectMode?t={min:1,max:this.tableWrapper.querySelector("table").rows[0].cells.length}:"column"===this.cursor.selectMode&&(r={min:1,max:this.tableWrapper.querySelector("table").rows.length});e:for(let s=r.min;s<=r.max;s++)for(let i=t.min;i<=t.max;i++){if(-1!==e.indexOf(i+"-"+s))continue;const l=this.tableWrapper.querySelector('td[data-col="'+i+'"][data-row="'+s+'"][colspan],td[data-col="'+i+'"][data-row="'+s+'"][rowspan]');if(null===l)continue;const a=n(l,!1);e.push(a.colIndex+"-"+a.rowIndex);const o=n(l,!0);if(o.colIndex>t.max||o.rowIndex>r.max){this.selection=[...this.selection.elements,l],this.calculateMergeCells(e);break e}}const s=this.tableWrapper.querySelectorAll("td[colspan], td[rowspan]");for(let i=0;i<s.length;++i){const l=s[i],a=n(l,!1);if(-1!==e.indexOf(a.colIndex+"-"+a.rowIndex))continue;const o=n(l,!0);if((a.colIndex<t.min&&"column"===this.cursor.selectMode||a.rowIndex<r.min&&"row"===this.cursor.selectMode)&&o.colIndex>=t.min&&o.rowIndex>=r.min){this.selection=[...this.selection.elements,l],this.calculateMergeCells(e);break}}}highlightSelection(){const e=this.selection.indexes.col,t=this.selection.indexes.row,r=[];if("row"===this.cursor.selectMode)for(let e=t.min;e<=t.max;e++)r.push(...this.tableWrapper.querySelectorAll('td[data-row="'+e+'"]'));else if("column"===this.cursor.selectMode)for(let t=e.min;t<=e.max;t++)r.push(...this.tableWrapper.querySelectorAll('td[data-col="'+t+'"]'));else for(let s=e.min;s<=e.max;s++)for(let e=t.min;e<=t.max;e++)r.push(this.tableWrapper.querySelector('td[data-col="'+s+'"][data-row="'+e+'"]'));Array.from(this.tableWrapper.querySelectorAll("td.highlight")).filter((e=>null!==e)).forEach((e=>e.classList.remove("highlight"))),r.filter((e=>null!==e)).forEach((e=>e.classList.add("highlight")))}}var h=s(384),c=s.n(h);class u{constructor(e){this.element=e,this.sheetWrapper=this.element.querySelector(".spreadsheet-sheets"),this.tableWrapper=this.element.querySelector(".spreadsheet-table"),this.fileInput=this.element.querySelector(".spreadsheet-file-select"),this.directionInput=this.element.querySelector(".spreadsheet-input-direction"),this.resetInput=this.element.querySelector(".spreadsheet-reset-button"),this.originalDataInput=this.element.querySelector("input.spreadsheet-input-original"),this.databaseDataInput=this.element.querySelector("input.spreadsheet-input-database"),this.formattedDataInput=this.element.querySelector("input.spreadsheet-input-formatted"),this.dsn=new l(this.databaseDataInput.getAttribute("value")),this.spreadsheet=new o(this.dsn,JSON.parse(this.element.getAttribute("data-spreadsheet"))),this.renderer=new a(this.sheetWrapper,this.tableWrapper),this.selector=new d(this.tableWrapper),this.updateSpreadsheet(!0),this.initializeEvents()}initializeEvents(){this.fileInput.addEventListener("change",(e=>{this.dsn.fileUid=e.currentTarget.value,this.dsn.index=0,this.dsn.range="",this.updateSpreadsheet(!0)})),this.sheetWrapper.addEventListener("changeIndex",(e=>{this.dsn.index=e.detail.index,this.updateSpreadsheet(!0)})),this.resetInput.addEventListener("click",(()=>{this.dsn=new l(this.originalDataInput.getAttribute("value")),this.updateSpreadsheet(!0)})),null!==this.tableWrapper&&this.tableWrapper.addEventListener("changeSelection",(e=>{"string"==typeof e.detail.start&&e.detail.start===e.detail.end&&e.detail.start.match(/^(?=.*\d)(?=.*[A-Z]).+$/)?this.dsn.range=e.detail.start:this.dsn.range=e.detail.start+":"+e.detail.end,this.updateSpreadsheet()})),null!==this.tableWrapper&&null!==this.directionInput&&this.directionInput.addEventListener("click",(e=>{const t=e.currentTarget,r=t.parentNode;this.dsn.direction="horizontal"===(t.value||"horizontal")?"vertical":"horizontal",t.setAttribute("value",this.dsn.direction),"horizontal"!==this.dsn.direction?(r.querySelector(".direction-row").style.display="none",r.querySelector(".direction-column").style.display="block"):(r.querySelector(".direction-column").style.display="none",r.querySelector(".direction-row").style.display="block"),this.updateSpreadsheet()}))}updateSpreadsheet(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.spreadsheet.dsn=this.dsn,!0===e&&this.renderer.update(this.spreadsheet,this.dsn),this.fileInput.value=this.dsn.fileUid;let t=this.spreadsheet.getSheetName(),r="";void 0!==this.dsn.fileUid&&void 0!==this.dsn.index&&(r+="spreadsheet://"+this.dsn.fileUid+"?index="+this.dsn.index),null!==this.tableWrapper&&this.dsn.range.length>0&&(t+=" - "+this.dsn.range,r+="&range="+this.dsn.range),null!==this.tableWrapper&&null!==this.directionInput&&this.dsn.direction.length>0&&(r+="&direction="+this.dsn.direction),this.formattedDataInput.setAttribute("value",t),this.databaseDataInput.setAttribute("value",r)}}c().ready().then((()=>{document.querySelectorAll(".spreadsheet-input-wrap").forEach((e=>{new u(e)}))})).catch((()=>{console.error("Failed to load DOM for processing spreadsheet inputs!")}))}(),i}()}));